CREATE TABLE `rakamin-kf-analytics-477007.kimia_farma.tabel_analisa` AS

WITH 
-- JOIN TABLE
BaseJoin AS (
  SELECT
    t.transaction_id,
    t.date AS date,
    t.branch_id,
    t.customer_name,
    t.product_id,
    t.price,
    t.discount_percentage,
    t.rating AS rating_transaksi,
    c.branch_name,
    c.kota,
    c.provinsi,
    c.rating AS rating_cabang,
    p.product_name
  FROM
    `rakamin-kf-analytics-477007.kimia_farma.kf_final_transaction` AS t
  LEFT JOIN
    `rakamin-kf-analytics-477007.kimia_farma.kf_kantor_cabang` AS c
    ON t.branch_id = c.branch_id
  LEFT JOIN
    `rakamin-kf-analytics-477007.kimia_farma.kf_product` AS p
    ON t.product_id = p.product_id
),

-- HITUNG KOLOM TAMBAHAN
Calculations AS (
  SELECT
    transaction_id,
    date,
    branch_id,
    customer_name,
    product_id,
    price,
    discount_percentage,
    rating_transaksi,
    branch_name,
    kota,
    provinsi,
    rating_cabang,
    product_name,

    -- HITUNG PERSENTASE LABA
    CASE
      WHEN price <= 50000 THEN 0.10
      WHEN price > 50000 AND price <= 100000 THEN 0.15
      WHEN price > 100000 AND price <= 300000 THEN 0.20
      WHEN price > 300000 AND price <= 500000 THEN 0.25
      WHEN price > 500000 THEN 0.30
    END AS persentase_gross_laba,

    -- HITUNG NETT SALES
    (price - (price * discount_percentage)) AS nett_sales

  FROM BaseJoin
)

-- KOLOM AKHIR
SELECT
  transaction_id,
  date,
  branch_id,
  branch_name,
  kota,
  provinsi,
  rating_cabang,
  customer_name,
  product_id,
  product_name,
  price AS actual_price,
  discount_percentage,
  persentase_gross_laba,
  nett_sales,
  (nett_sales * persentase_gross_laba) AS nett_profit,
  rating_transaksi
FROM
  Calculations;
